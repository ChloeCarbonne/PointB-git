---
title: "Time series at Point B"
author: "Jean-Pierre Gattuso, CNRS-SU (gattuso@obs-vlfr.fr), Maia Durozier, Jean-Olivier Irisson and Laure Mousseau"
date: '`r format(Sys.Date(), "%d %B %Y")`'
output:
  html_document:
    code_folding: hide
    fig_caption: yes
    toc: no
    toc_float: no
  pdf_document:
    toc: no
---


```{r setup, include=FALSE}
##
rm(list = ls())
require(readxl)
require(seacarb)
library(ggplot2)
library(cowplot)
library(scales)
library(RColorBrewer)
library(gridExtra)
library(reshape2)
library(xtable)
library(zoo)
library(lubridate)
library(nlme)
library(lmtest)
library(dplyr)
library(readr)
library(tidyr)
library(grid)
library(viridis)
library(animation)
library(directlabels)
library(tibble)
require("knitr")
library(broom)
library(dygraphs)
library(xts)
# install.packages("devtools")
#devtools::install_github("jiho/castr")
library(castr)
library(colorspace)


#define who is the user and define path
if (Sys.getenv("LOGNAME") == "gattuso") path = "../../pCloud\ Sync/Documents/experiments/exp153_carbonates_point_B/"
if (Sys.getenv("LOGNAME") == "samir") path = "../../pCloud Sync/exp153_carbonates_point_B/"

Sys.setenv(TZ='UTC')
dc1 <- "#482173FF" #discrete color 1
dc2 <- "#51C56AFF" #discrete color 2: 
dc3 <- "#482173FF" #discrete color 1
dc4 <- "#51C56AFF" #discrete color 2: 

size_labs <- 6
face_font <- "plain"

Mytheme <- function(size_labs = 6, face_font="plain", ...) {
  theme_bw() +
  theme(axis.text.x = element_text(face=face_font, size=size_labs, color="black"),
        axis.title.x = element_text(face=face_font, size=size_labs, margin=margin(0,0,0,0,"pt")),
        axis.text.y = element_text(face=face_font, color="black", size=size_labs),
        axis.title.y = element_text(face=face_font, size=size_labs),
        axis.ticks.x = element_line(size=0.1),
        axis.ticks.y = element_line(size=0.1),
        axis.ticks.length = unit(1.1, "mm"),
        panel.grid.major = element_line(size = 0.25, color="black", linetype="dotted"),
        #aspect.ratio = 1 / 3,
        plot.margin = margin(t = 0, r = 1, b = 0, l = 0, unit = "lines"),
        legend.position = "none"
  )
}

######## To add regression line on ggplots
# use as annotate(aes(x = 25, y = 300, label = lm_eqn(lm(y ~ x, df))), parse = TRUE)
# http://stackoverflow.com/questions/7549694/ggplot2-adding-regression-line-equation-and-r2-on-graph
lm_eqn = function(m) {
  l <- list(a = format(coef(m)[1], digits = 2),
      b = format(abs(coef(m)[2]), digits = 2),
      r2 = format(summary(m)$r.squared, digits = 3));
  if (coef(m)[2] >= 0)  {
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2,l)
  } else {
    eq <- substitute(italic(y) == a - b %.% italic(x)*","~~italic(r)^2~"="~r2,l)    
  }
  as.character(as.expression(eq));                 
}

######## function to make regression plot with model I equation in title
ggreg <- function (fit, point_size=2) {
  ggplot(fit$model, aes_string(x = names(fit$model)[2],
                               y = names(fit$model)[1])) +
    geom_point(size = point_size, col = "blue") +
    stat_smooth(method = "lm", col = "black") +
    labs(title = paste(title, "\nAdj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                       "; Intercept =",signif(fit$coef[[1]],5 ),
                       "; Slope =",signif(fit$coef[[2]], 5),
                       "; P =",signif(summary(fit)$coef[2,4], 5))) +
    theme(plot.title = element_text(size=7))
}

```
```{r test regression, include=FALSE}
# This is to test linear regressions with dates
# Conclusion is that the slope is per day but I have decided to use decimal_date() to avoid any confusion
dt <- as_date(c("1916-06-16", "2016-06-15"))
temp <- c(20, 21)
dat <- data.frame(dt, temp)
reg <- lm(data=dat,temp ~ dt)
slope <- 365*coef(reg)[2]
```


```{r read_data, include=FALSE}
# read data and create a data frame tbl
dat <-  read_delim(
  paste0(path,"data/", "radehydro_ctd_20190716.csv"),
  delim = ",",
  col_names = TRUE,
  col_types = cols(fluo_calib = "d", fluorescence="d", oxygen_mll="d", oxygen_sat="d", 
                   oxygen_umolkg="d", par="d", v0="d", v2="d"),
  na = c("NA")
) %>%
  dplyr::rename(depth = pressure) %>%
  dplyr::filter(station == "B") # only keep Point B
```

```{r ctds, fig.width=10, fig.height=4, echo=FALSE, message= FALSE, warning = FALSE}
p <- NULL; j <- 0
for (i in (1992:2018)) {
  j <- j + 1
  p[[j]] <- ggplot(data = filter(dat, year(date) == i)) + 
  geom_path(aes(x=temperature, y=-depth, group=date, colour = factor(month(date, label = TRUE))), alpha=0.8) +
   scale_color_discrete_sequential(palette = "Purples 3", nmax = 12) +
  labs(x = "Temperature", y = "Depth (m)") +
    xlim(12, 28) + ylim(-100, 0) +
  annotate("text", x = 26, y = -80, label = as.character(i), size = 4) +
    Mytheme() +
        theme(legend.position = "none")

}
g <- plot_grid(p[[1]], p[[2]], p[[3]], p[[4]], p[[5]], p[[6]], p[[7]], p[[8]], p[[9]], p[[10]], 
                p[[11]], p[[12]], p[[13]], p[[14]], p[[15]], p[[16]], p[[17]], p[[18]], p[[19]], p[[20]],
                p[[21]], p[[22]], p[[23]], p[[24]], p[[25]], p[[26]], p[[27]],
                ncol=1, align="h")
ggsave(file="figures/ctd.png", g, width = 20, height = 150, units = "cm", limitsize = FALSE)

  # j <- 1
  # i <- 2017
  # p[[j]] <- ggplot(data = filter(dat, year(date) == i)) + 
  # geom_path(aes(x=temperature, y=-depth, group=date, colour = factor(month(date, label = TRUE))), alpha=0.8) +
  #  scale_color_discrete_sequential(palette = "Purples 3", nmax = 12) +
  # labs(x = "Temperature", y = "Depth (m)", colour = "Month") +
  #   xlim(12, 28) + ylim(-100, 0) +
  # annotate("text", x = 24, y = -80, label = as.character(j), size = 4) +
  #   theme(legend.position = "none")
  # p[[j]]
```
![ctd](figures/ctd.png)


```{r whole time series, fig.width=10, fig.height=4, echo=FALSE, message= FALSE}
#Temperature
temp_xts <- dat %>%
  dplyr::select(date, temperature)%>%
  as.xts(temperature, order.by = dat$date)
dygraph(temp_xts, group = "pointB", main="Temperature", ylab="Temperature") %>%
      dySeries("temperature", color = "blue", strokeWidth = 0, label = "T") %>%
      dyHighlight(highlightCircleSize = 8, highlightSeriesBackgroundAlpha =0.2,hideOnMouseOut =TRUE) %>%
      dyOptions(drawGrid = TRUE, drawPoints = TRUE, pointSize = 2,useDataTimezone = TRUE) %>%
      dyRangeSelector(height = 30)
```

```{r thermocline, fig.width=10, fig.height=4, echo=FALSE, message= FALSE}
stats <- dat %>% group_by(date) %>%
  summarise(
    thermocline = clined(temperature, depth, n.smooth=2, k=2)
#    pycnocline = clined(sigma, depth),
#    strat_index = stratif(sigma, depth, min.depths=0:5, max.depth=60:65),
#    DCM = maxd(fluo, depth, n.smooth=2, k=3),
#    MLD = mld(sigma, depth, ref.depths=0:5, default.depth=80),
    # it is even possible to use variables computed above to make the
    # following computations adapted to each cast:
    # average tempeature in the mixed layer only
#    temp_avg = integrate(temp, depth, from=0, to=MLD, fun=mean),
    # stock of Chl a within 10 m of the DCM
#    chla_dcm_stock = integrate(fluo, depth, from=DCM-10, to=DCM+10)
  )

therm_xts <- stats %>%
  dplyr::select(date, thermocline)%>%
  as.xts(thermocline, order.by = stats$date)
dygraph(therm_xts, group = "pointB", main="Thermocline", ylab="Thermocline") %>%
      dySeries("thermocline", color = "blue", strokeWidth = 0, label = "Th") %>%
      dyHighlight(highlightCircleSize = 8, highlightSeriesBackgroundAlpha =0.2,hideOnMouseOut =TRUE) %>%
      dyOptions(drawGrid = TRUE, drawPoints = TRUE, pointSize = 2,useDataTimezone = TRUE) %>%
      dyRangeSelector(height = 30)

# therm_plot <- ggplot(data = stats, aes(x = date, y = thermocline)) + geom_path()
# ggsave(filename = "figures/therm_plot.png", plot = therm_plot)


# v <- ggplot(filter(z, date>"2016-01-01", date<"2016-12-31"), 
#             aes(x=date,y=pressure,z=temperature, fill=temperature)) +
#   geom_raster() +
#   scale_y_reverse(expand=c(0,0)) +
#   #scale_fill_gradientn(colours=matlab.like(10), na.value = 'gray', name="Water\nTemp \nÂºC") + 
#   scale_fill_viridis_d() +
#   scale_x_date(date_breaks = "1 week", 
#                    # limits = as_date(c('2016-12-06','2017-02-25')),
#                    labels=date_format("%b-%d"), expand=c(0,0)) + 
#   ylab("Depth (m)") +
#   xlab("")
# ggsave(filename = "figures/temp.png", plot = v)
```


```{r averages, fig.width=10, fig.height=4, echo=FALSE, message= FALSE}
ave_all <- dat %>%
  dplyr::mutate(month = month(x = date),
                range = cut(dat$depth, breaks = c(0, 5, 10, 20, 30, 50, 200), include.lowest = TRUE, right = TRUE),
                range = forcats::fct_explicit_na(range, na_level = "(Missing)")) %>%
 # dplyr::filter(month == 6 & month == 7) %>%
  group_by(month, range) %>%
  summarize(temp = mean(temperature, na.rm = TRUE), n = n())
ave_all

ave_2019 <- dat %>%
  dplyr::mutate(month = month(date),
                year = year(date),
                range = cut(dat$depth, breaks = c(0, 5, 10, 20, 30, 50, 200), include.lowest = TRUE, right = TRUE),
                range = forcats::fct_explicit_na(range, na_level = "(Missing)")) %>%
  dplyr::filter(year == 2019) %>%
  group_by(month, range) %>%
  summarize(temp_2019 = mean(temperature, na.rm = TRUE), n = n())
ave_2019

ext <- left_join(ave_all, ave_2019, by = c("month", "range"))  %>%
  dplyr::filter(range != "(missing)")
  
temp_ts <- ggplot(ext, na.rm = TRUE) +
  geom_line(aes(x = month, y = temp, group = range, col = range), alpha = 0.2) +
  geom_line(aes(x = month, y = temp_2019, group = range, col = range)) +
  scale_x_continuous(breaks=seq(0,12, 1)) +
  scale_y_continuous(breaks=seq(12,30, 2)) 
ggsave2(temp_ts, filename = "figures/temp_ts.pdf")
```

